{{- /*
    Use lookup to preserve SESSION_SECRET_KEY across upgrades.
    If the Secret already exists, reuse its stored key.
    Otherwise fall back to .Values.sessionSecretKey or generate a random one.
*/}}
{{- $existingSecret := lookup "v1" "Secret" .Release.Namespace (include "jupyterhub-usage-quota-service.usage-quota-service.fullname" .) }}
{{- $sessionSecretKey := "" }}
{{- if $existingSecret }}
    {{- $sessionSecretKey = index $existingSecret.data "SESSION_SECRET_KEY" | b64dec }}
{{- else }}
    {{- $sessionSecretKey = .Values.sessionSecretKey | default (randAlphaNum 32) }}
{{- end }}
apiVersion: v1
kind: Secret
metadata:
  name: {{ include "jupyterhub-usage-quota-service.usage-quota-service.fullname" . }}
  labels:
    {{- include "jupyterhub-usage-quota-service.labels" . | nindent 4 }}
stringData:
  JUPYTERHUB_API_TOKEN: {{ .Values.jupyterhub.apiToken | quote }}
  SESSION_SECRET_KEY: {{ $sessionSecretKey | quote }}
